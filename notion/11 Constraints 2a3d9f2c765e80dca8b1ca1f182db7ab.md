# 11. Constraints

Категория: SQL Databases
Статус: Готово

Типы данных сами по себе ограничивают множество данных, которые можно сохранить в таблице. Однако для многих приложений такие ограничения слишком грубые. Например, столбец, который содержит цену продукта, вероятно, должен принимать только положительные значения. Но такого стандартного типа нет. 

Для решения подобных задач SQL позволяет определять ограничения для столбцов и таблиц. Ограничения дают вам возможность управлять данными в таблицах так, как вы захотите.

### Ограничения проверки

Это наиболее общий тип ограничений. В его определении можно указать, что значение столбца должно удовлетворять некому логическому выражению. Например, вот способ ограничить цену товара положительными значениями:

![image.png](image%20676.png)

Ограничению можно задать и имя, чтобы улучшить сообщение об ошибках и ссылаться на именно это ограничение. Выполнить это можно с помощью ключевого слова **`CONSTRAINT`**:

![image.png](image%20677.png)

Ограничение-проверка может еще ссылаться и на несколько столбцов:

![image.png](image%20678.png)

P.S. Следует заметить, что ограничение-проверка удовлетворяется, если выражение принимает значение true или NULL. Так как результатом многих выражений с операндами NULL будет значение NULL, такие ограничения не будут препятствовать записи NULL в ограничиваемые столбцы. Чтобы гарантировать, что столбец не содержит значения NULL, можно использовать ограничение NOT NULL.

### Ограничения NOT NULL

Ограничение NOT NULL просто указывает, что столбец не может принимать значение NULL. Пример использования (также можно указать и имя с помощью 
**`CONSTRAINT`**):

![image.png](image%20679.png)

Ограничение NOT NULL функционально эквивалентно ограничению `CHECK (***имя_столбца*** IS NOT NULL)`, но в PostgreSQL явное ограничение NOT NULL работает более эффективно.
P.S. В Postgres есть еще и ограничение NULL. По факту оно не имеет большого смысла и в стандарте SQL просто отсутствует, но оно имеется в Postgres только для совместимости с некоторыми другими СУБД.
P.S.S. При проектировании баз данных чаще всего большинство столбцов должны быть помечены как NOT NULL.

### Ограничение уникальности

Ограничения уникальности гарантируют, что данные в определённом столбце или группе столбцов уникальны среди всех строк таблицы. Ограничение записывается так:

![image.png](image%20680.png)

При добавлении ограничения уникальности будет автоматически создан уникальный индекс-B-дерево для столбца или группы столбцов, перечисленных в ограничении. Условие уникальности, распространяющееся только на некоторые строки, нельзя записать в виде ограничения уникальности, однако такое условие можно установить, создав уникальный [частичный индекс](https://postgrespro.ru/docs/postgresql/current/indexes-partial.html).

Как правило, ограничение уникальности нарушается, если в таблице оказывается несколько строк, у которых совпадают значения всех столбцов, включённых в ограничение. По умолчанию два значения NULL при таком сравнении не считаются равными. Это означает, что даже при наличии ограничения уникальности в таблице можно сохранить строки с дублирующимися значениями, если они содержат NULL в одном или нескольких ограничиваемых столбцах. Это поведение можно изменить, добавив предложение `NULLS NOT DISTINCT:`

![image.png](image%20681.png)

### Первичные ключи

Ограничение первичного ключа означает, что образующий его столбец или группа столбцов может быть уникальным идентификатором строк в таблице. Для этого требуется, чтобы значения были одновременно уникальными и отличными от NULL.

![image.png](image%20682.png)

При добавлении первичного ключа автоматически создаётся уникальный индекс-B-дерево для столбца или группы столбцов, перечисленных в первичном ключе, и данные столбцы помечаются как `NOT NULL`. 

Таблица может иметь не более одного первичного ключа. Теория реляционных баз данных предполагает, что каждая таблица должна иметь первичный ключ. В PostgreSQL это правило не контролируется, но обычно рекомендуется его соблюдать.

### Внешние ключи

Ограничение внешнего ключа указывает, что значения столбца должны соответствовать значениям в некоторой строке другой таблицы. Это называется ***ссылочной целостностью*** двух связанных таблиц.

![image.png](image%20683.png)

Для работы с удалением имеется ON DELETE:

![image.png](image%20684.png)

Действие по умолчанию для `ON DELETE` — `ON DELETE NO ACTION`; его указывать необязательно. Это означает, что удаление строки из связанной таблицы допускается. 

`RESTRICT` — более строгое значение по сравнению с `NO ACTION`. `RESTRICT` полностью запрещает удаление связанной строки и не допускает отложенной проверки до конца транзакции.

`CASCADE` указывает, что при удалении связанной строки автоматически удаляются все строки, ссылающиеся на неё.

Есть ещё два варианта: `SET NULL` и `SET DEFAULT`. При удалении целевой строки они назначают ссылающимся столбцам в ссылающихся строках значения NULL или значения по умолчанию, соответственно. 

Аналогично `ON DELETE` существует `ON UPDATE`, которое срабатывает при изменении значения целевого столбца. Возможные действия те же, за исключением того, что для `SET NULL` и `SET DEFAULT` нельзя указывать списки столбцов.

### Ограничения-исключения

Ограничения-исключения гарантируют, что при сравнении любых двух строк по указанным столбцам или выражениям с помощью заданных операторов, минимум одно из этих сравнений возвратит false или NULL. Записывается это так:

![image.png](image%20685.png)

При добавлении ограничения-исключения будет автоматически создан индекс того типа, который указан в объявлении ограничения.