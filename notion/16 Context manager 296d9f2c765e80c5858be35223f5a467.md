# 16. Context manager

Категория: Python Core
Статус: В процессе

Контекстные менеджеры - специальные конструкции, которые представляют из себя блоки кода, заключенные в инструкцию with. Инструкция with создает блок используя протокол контекстного менеджера. Простейшей функцией, использующей данный протокол является функция open(). 

Чтобы каждый раз не вызывать метод close() можно воспользоваться контекстным менеджером функции open(), которая автоматически закроет файл после выхода из блока: 

![image.png](image%20187.png)

Пример простого контекстного менеджера:

![image.png](image%20188.png)

![image.png](image%20189.png)

Чтобы объект стал контекстным менеджером в его класс обязательно должны входить два метода: __**enter__** и __**exit__**. 

Метод _**enter__** выполняется до входа в блок. Если ему возвратить экземпляр класса, то к нему можно будет обращаться через инструкцию as.

Метод __**exit__** выполняется ****после выхода из блока with и содержит 3 параметра: exp_type, exp_value и exp_tr. 

Переменная exp_type содержит в себе класс исключения, которое было возбуждено, exp_value — сообщение исключения.

Кстати, внутри блока with можно подавлять и такие исключения как NameError, SyntaxError, но этого делать не стоит.

Используя декоратор contextmanager() из contexlib мы можем из обычной функции сделать контекстный менеджер:

![image.png](image%20190.png)

![image.png](image%20191.png)

Еще один пример:

![image.png](image%20192.png)

![image.png](image%20193.png)

Рассмотрим еще и порядок действий при работе с контекстным менеджером:

![image.png](image%20194.png)

Выражение `with` в Python **используется для управления ресурсами с помощью менеджеров контекста, автоматизируя процессы настройки и освобождения ресурсов, таких как открытие и закрытие файлов**. Оно заменяет собой блок `try...finally` и гарантирует, что необходимые действия (например, закрытие файла) будут выполнены даже в случае возникновения ошибки. 

Преимущества использования контекстного менеджера: 

1. Автоматическое освобождение ресурсов (гарантия что нужные действия выполнятся даже в случае ошибки).
2. Упрощение кода 
3. Надежность 

Области применения контекстным менеджеров:

1. Работа с файлами: Самый частый пример – открытие и закрытие файлов с помощью `with open(...)`.
2. **Сетевые соединения:** Открытие и закрытие соединений, например, с базой данных.
3. **Блокировки:** Обеспечение того, что блокировки ресурсов (например, в многопоточных приложениях) будут сняты, чтобы другие потоки могли получить доступ.