# 17. Other

Категория: SQL Databases
Статус: Готово

## Cursor

Инкрементальное извлечение имеют решающее значение, особенно при работе с большим набором данных. Используя cursor в Postgres разработчики могут достичь большем производительности во время получения строк. 

Cursor - объект БД, позволяющий перемещаться по результирующему набору строк. Он действует как курсор, позволяющий последовательно извлекать строки. Они особенно полезны при работе с большими таблицами, где обычный SELECT может привести к проблемам с производительностью.

### Объявление курсора

![image.png](image%20713.png)

Объяснение:

- **`DECLARE`**: Ключевое слово для объявления курсора.
- **`cursor_name`**: Имя курсора для обращения.
- **`query`**: SQL запрос для курсора

### Получение данных из курсора

После объявления курсора можно получить данные, используя FETCH. Если строка не найдена, курсор вернет NULL.

![image.png](image%20714.png)

### Параметры:

- **`'[direction (rows)]'`**: Определяет направление и число строк для получения. По умолчанию направление - `NEXT`.
- **`'[cursor_name]'`**: Имя курсора, из которого мы будем получать данные.

### Directions for FETCH

- **NEXT**: Fetches the next rows.
- **PRIOR**: Fetches the previous rows.
- **FIRST**: Fetches the first rows.
- **LAST**: Fetches the last rows.
- **ALL**: Fetches all remaining rows.
- **FORWARD count**: Fetches the next '**`count'`** rows.
- **BACKWARD count**: Fetches the previous '**`count'`** rows.

### Пример использования

У нас есть такая таблица с такими данными:

![image.png](image%20715.png)

Теперь можем объявлять курсор:

![image.png](image%20716.png)

![image.png](image%20717.png)

![image.png](image%20718.png)

Используя это мы можем получить 9 строку и 8 соответственно.

![image.png](image%20719.png)

![image.png](image%20720.png)

### Важные моменты о курсорах в Postgres

- Курсоры должны быть объявлены внутри транзакции, в противном случае курсор ограничен сессией
- По умолчанию курсоры в Postres прокручиваются, т.е. мы можем задавать направление (**NEXT, PRIOR, FIRST, LAST**). Непрокручиваемые курсоры могут перемещать только вперед и объявляются с опцией “**NO SCROLL”**
- Postgres поддерживает различные типы курсоров, например, BINARY и INSENSITIVE. Курсор по умолчанию — INSENSITIVE, то есть он не отражает изменения, внесенные после открытия курсора.
- Извлечение данных небольшими порциями (например, «FETCH 100 FROM my_cursor») может повысить производительность за счет сокращения потребления памяти и времени обработки.

`pg_cron` — это **расширение для PostgreSQL, которое действует как встроенный планировщик заданий, позволяя выполнять задачи, такие как SQL-запросы или вызовы хранимых процедур, по расписанию непосредственно внутри базы данных**. Оно использует стандартный синтаксис `cron` и удобно для регулярного обслуживания базы данных, например, для очистки данных, агрегации или других повторяющихся операций, без необходимости использовать внешние инструменты.