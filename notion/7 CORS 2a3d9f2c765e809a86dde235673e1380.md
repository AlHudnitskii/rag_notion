# 7. CORS

Категория: Web & Networks
Статус: Готово

Cross-Origin Resource Sharing (CORS) - механизм, использующий дополнительные HTTP-заголовки, чтобы дать возможность агенту пользователю получать разрешение на доступ к выбранным ресурсам с сервера на источнике, отличном от того, что использует в данный момент. Агент пользователя делает запрос с другого источника (cross-origin HTTP request), если источник текущего документа отличается от запрашиваемого ресурса доменом, протоколом или портом.

CORS (Cross-Origin Resource Sharing) нужны **для того, чтобы браузер мог безопасно взаимодействовать с ресурсами, расположенными на разных доменах, разрешая или блокируя запросы с помощью специальных HTTP-заголовков**. Они предотвращают несанкционированный доступ к данным и защищают пользователей от атак, таких как XSS (Cross-Site Scripting). 

Пример кросс-доменного (cross-origin) запроса: веб-страница с адресом [https://mysite.com](https://mysite.com/) запрашивает данные у API на [https://api.example.com/data](https://api.example.com/data). Для этого браузер автоматически добавляет заголовок Origin: [https://mysite.com](https://mysite.com/) к запросу, чтобы сервер [api.example.com](http://api.example.com/) знал, кто отправляет запрос. 

CORS используется для разрешения кросс-сайтовых HTTP запросов для:

- Вызова [`XMLHttpRequest`](https://developer.mozilla.org/ru/docs/Web/API/XMLHttpRequest) или [Fetch](https://developer.mozilla.org/ru/docs/Web/API/Fetch_API) APIs в кросс-сайт манере, как описано выше.
- Web Fonts (для кросс-доменного использования шрифтов в `@font-face` в рамках CSS).
- Стили (для [CSSOM](https://developer.mozilla.org/en-US/docs/Web/CSS/Guides/CSSOM_view) доступа).
- Скрипты (для отключённых исключений).

Стандарт Cross-Origin Resource Sharing работает с помощью добавления новых [HTTP-заголовков](https://developer.mozilla.org/ru/docs/Web/HTTP/Reference/Headers), которые позволяют серверам описывать набор источников, которым разрешено читать информацию, запрашиваемую web-браузером.

### Пример запроса и ответа, использующего CORS

![image.png](image%20565.png)

![image.png](image%20566.png)

Заголовок `Access-Control-Allow-Origin` должен содержать значение, которое было отправлено в заголовке `Origin` запроса.

[https://www.notion.so](https://www.notion.so)

### Виды CORS-запросов

**1. Простые запросы (Simple requests)**

- Браузер отправляет запрос непосредственно без предварительной проверки.
- **Условия:**
    - Используется один из методов: `GET`, `HEAD` или `POST`.
    - Заголовок `Content-Type` имеет одно из следующих значений: `application/x-www-form-urlencoded`, `multipart/form-data` или `text/plain`.
    - В запросе присутствуют только заголовки, которые считаются "безопасными" (CORS-safe-listed request headers).
    
    ![image.png](image%20567.png)
    
    ![image.png](image%20568.png)
    

**2. Предварительные запросы (Preflight requests)**

- Браузер сначала отправляет `OPTIONS` запрос, чтобы узнать, разрешено ли выполнение основного запроса.
- **Условия:**
    - Метод запроса не является `GET`, `HEAD` или `POST` (например, `PUT`, `DELETE`, `PATCH`).
    - В запросе используются заголовки, не являющиеся "безопасными" (например, `Content-Type` с другим значением, чем у простых запросов, или пользовательские заголовки).
    - В запросе используется тело (например, `ReadableStream`).
    - На `XMLHttpRequestUpload` зарегистрированы обработчики событий.

![image.png](image%20569.png)

![image.png](image%20570.png)