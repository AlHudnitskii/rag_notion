# 3. DNS & NAT

Категория: Web & Networks
Статус: Готово

## DNS

DNS (Domain Name System, система доменных имен) - телефонная книга интернета. Люди ищут информацию через доменные имена, например, [google.com](http://google.com/). Однако сами браузеры взаимодействуют посредством IP-адресов. DNS преобразует доменные имена в IP-адреса, чтобы браузер мог загружать интернет-ресурсы.

DNS-серверы избавляют людей от необходимости запоминать IP-адреса, такие как 192.168.1.1 (в IPv4), или более сложные новые буквенно-цифровые IP-адреса, такие как 2400:cb00:2048:1::c629:d7a2 (в IPv6).

![image.png](image%20513.png)

### В загрузке веб-страницы участвуют 4 DNS-сервера:

- DNS-recursor — сервер, предназначенный для приема запросов от клиентских компьютеров через веб-браузер.
- Root Nameserver — первый шаг в преобразовании удобночитаемых имен хостов в IP-адреса.
- TLD Nameserver (сервер имен доменов верхнего уровня) — следующий шаг в поиске IP-адреса, и на нем размещается последняя часть имени хоста (в [example.com](http://example.com), сервер TCD - ‘com’)
- Authoritative Nameserver — последняя точка в запросе сервера имен. Возвращает IP-адрес для запрошенного хоста обратно DNS-recursor’y.

### **Recursive DNS resolver**

Recursive resolver — компьютер, отвечающий за рекурсивный запрос клиента и ищущий записи DNS. Он делает это, выполняя серию запросов, пока не достигнет авторитетного сервера DNS-имен для запрашиваемой записи (или не истечет время ожидания, или не будет возвращена ошибка, если запись не найдена). 

### **Authoritative DNS server**

Authoritative DNS server —  сервер, который фактически хранит записи ресурсов DNS и отвечает за них. Авторитетный сервер имен может удовлетворять запросы из своих собственных данных без необходимости обращаться к другому источнику, поскольку он является окончательным источником достоверности для определенных записей DNS.

Стоит отметить, что в случаях, когда запрос выполняется для поддомена, такого как [foo.example.com](http://foo.example.com/) или [blog.cloudflare.com](http://blog.cloudflare.com/), дополнительный сервер имен будет добавлен в последовательность после авторитетного сервера имен, который отвечает за хранение записи CNAME поддомена.

![image.png](image%20514.png)

### 8 шагов в поиске DNS:

1. Пользователь вводит ‘example.com’ в браузере, запрос отправляется в интернет и принимается рекурсивным преобразователем DNS.
2. Преобразователь запрашивает корневой сервер имен DNS (.)
3. Корневой сервер отправляет в ответ на запрос адрес TLD (.com, .net)
4. Преобразователь оправляет запрос в домен TLD .com
5. Сервер TCD отправляет IP-адрес домена сервера, exaple.com
6. Преобразователь отправляет запрос на сервер имен домена
7. Преобразователю возвращается IP-адрес для [exaple.com](http://exaple.com) с сервера имен.
8. DNS отвечает веб-браузеру IP-адресом домена, запрошенного изначально.

После этих 8 пунктов:

1. Браузер выполнил HTTP-запрос на IP-адрес
2. Сервер с этим IP-адресов вернет браузеру отображаемую страницу.

![image.png](image%20515.png)

Resolver (Преобразователь, Распознаватель) -  это первая остановка в поиске DNS, и он отвечает за работу с клиентом, отправившим первоначальный запрос. Распознаватель запускает последовательность запросов, которая в конечном итоге приводит к преобразованию URL-адреса в необходимый IP-адрес.

Важно различать рекурсивный DNS-запрос и рекурсивный DNS-распознаватель. Запрос - это запрос, направленный в DNS-распознаватель, требующий разрешения запроса. Рекурсивный распознаватель DNS - это компьютер, который принимает рекурсивный запрос и обрабатывает ответ, отправляя необходимые запросы.

![image.png](image%20516.png)

### Типы DNS-запросов

- Рекурсивный запрос — в рекурсивном запросе DNS-клиент требует, чтобы DNS-сервер  ответил клиенту либо запрошенной записью ресурса, либо сообщением об ошибке, если распознаватель не может найти запись.
- Повторяющийся запрос — в этой ситуации DNS-клиент позволит DNS-серверу вернуть наилучший возможный ответ. Если запрошенный DNS-сервер не соответствует имени запроса, он вернет ссылку на DNS-сервер, имеющий полномочия для более низкого уровня доменного пространства имен. Затем DNS-клиент отправит запрос на указанный адрес. Этот процесс продолжается с использованием дополнительных DNS-серверов по цепочке запросов до тех пор, пока не возникнет ошибка или тайм-аут.
- Нерекурсивный запрос — обычно это происходит, когда клиент DNS-распознавателя запрашивает у DNS-сервера запись, к которой у него есть доступ, либо потому, что он является авторитетным для этой записи, либо потому, что запись существует в его кэше. Как правило, DNS-сервер кэширует DNS-записи, чтобы предотвратить дополнительное потребление полосы пропускания и нагрузку на вышестоящие серверы.

### DNS кэширование

Кэширование DNS предполагает хранение данных ближе к запрашивающему клиенту, что позволяет быстрее разрешить запрос DNS и избежать дополнительных запросов дальше по цепочке поиска DNS.

### Кэширование DNS в браузере

Современные веб-браузеры по умолчанию запрограммированы на кэширование записей DNS на определенный период времени. Цель этого очевидна: чем ближе к веб-браузеру происходит кэширование DNS, тем меньше операций обработки требуется для проверки кэша и выполнения правильных запросов к IP-адресу. При запросе DNS-записи в первую очередь проверяется наличие запрошенной записи в кэше браузера.

### Кэширование на уровне OS

Распознаватель DNS на уровне операционной системы является второй и последней локальной остановкой перед отправкой запроса DNS с вашего компьютера. Процесс внутри вашей операционной системы, предназначенный для обработки этого запроса, обычно называется “распознавателем заглушек” или DNS-клиентом. Когда распознаватель заглушек получает запрос от приложения, он сначала проверяет свой собственный кэш, чтобы узнать, есть ли в нем запись. Если этого не происходит, то он отправляет DNS-запрос.

Рекурсивный распознаватель также обладает дополнительной функциональностью в зависимости от типов записей, хранящихся в его кэше:

1. Если у распознавателя нет записей A, но есть записи NS для авторитетных серверов имен, он будет запрашивать эти серверы имен напрямую, минуя несколько этапов DNS-запроса. Этот ярлык предотвращает поиск с корневого сервера и сом-сервера имен (в нашем поиске по [example.com](http://example.com/)) и помогает быстрее выполнять DNS-запрос.
2. Если у распознавателя нет записей NS, он отправит запрос на серверы TLD (в нашем случае .com), минуя корневой сервер.
3. В том маловероятном случае, если у распознавателя не будет записей, указывающих на серверы TLD, он запросит корневые серверы. 

### Типичные DNS ошибки

1. **`DNS_PROBE_FINISHED_NXDOMAIN`  -** ошибка несуществующего доменного имени.
2. **`DNS_PROBE_FINISHED_NO_INTERNET` -** доменное имя существует, но DNS-сервер недоступен. 

## NAT

Network Address Translation (NAT) - сетевой метод, позволяющий нескольким устройствам в частной сети получать доступ к внешним сетям (например, к Интернету), используя единый общедоступный IP-адрес. Преобразуя частные IP-адреса в общедоступные IP-адреса и наоборот, NAT сохраняет ограниченный пул IPv4-адресов и повышает уровень безопасности, маскируя внутренние адреса от внешнего мира.

![image.png](image%20517.png)

Примечание: IPv4 предоставляет только 2 ** 32 адреса (около 4,3 миллиарда), что недостаточно, учитывая огромное количество устройств, подключенных к Интернету. NAT предотвращает исчерпание IP-адресов, позволяя тысячам частных устройств совместно использовать ограниченное количество общедоступных IP-адресов.

### Принцип работы NAT

Когда устройство в частной сети хочет подключиться к Интернету, запрос сначала отправляется маршрутизатору с поддержкой NAT. Маршрутизатор заменяет частный IP-адрес на общедоступный IP-адрес и присваивает уникальный номер порта. Это сопоставление записывается в таблицу NAT.

![image.png](image%20518.png)

Примечание: Когда приходит ответ от внешнего сервера, NAT использует сохраненную запись для идентификации правильного внутреннего устройства. Затем он заменяет общедоступный IP-адрес и порт на исходный частный IP-адрес и пересылает пакет обратно на устройство.

Данный принцип работы гарантирует, что:

- Несколько устройств могут совместно использовать один общедоступный IP-адрес.
- Внутренние адреса скрыты от внешних сетей
- Трафик в разных устройств помогают различать номера портов.

### Почему NAT маскирует номера портов?

Маскировка исходного порта NAT означает **динамическую трансляцию как IP-адреса, так и номера порта отправителя пакета при его прохождении через маршрутизатор**.

Предположим, что в сети подключены два хоста A и B. Теперь оба они запрашивают один и тот же адресат, используя один и тот же номер порта, скажем, 1000, на стороне хоста, в одно и то же время.
Если NAT выполняет только преобразование IP-адресов, то, когда их пакеты будут поступать в NAT, оба их IP-адреса будут замаскированы общедоступным IP-адресом сети и отправлены по назначению.
Получатель будет отправлять ответы на общедоступный IP-адрес маршрутизатора. Таким образом, при получении ответа NAT будет неясно, какой ответ принадлежит какому хосту (поскольку номера портов-отправителей для A и B совпадают).
Следовательно, чтобы избежать подобной проблемы, NAT также маскирует номер исходного порта и вносит запись в таблицу NAT.

### Внутренние и внешние адреса NAT

Внутренние адреса относятся к адресам, которые необходимо преобразовать. Внешние адреса относятся к адресам, которые не контролируются организацией. Это сетевые адреса, по которым будет выполняться преобразование.

![image.png](image%20519.png)

- Внутренний локальный адрес: IP-адрес, назначенный хосту во внутренней (локальной) сети. Это внутренний хост, который виден из внутренней сети.
- Внутренний глобальный адрес: IP-адрес, который представляет один или несколько внутренних локальных IP-адресов для внешнего мира. Это внутренний хост, видимый из внешней сети.
- Внешний локальный адрес: Это фактический IP-адрес конечного хоста в локальной сети после преобразования.
- Внешний глобальный адрес: это внешний хост, видимый из внешней сети. Это IP-адрес внешнего целевого хоста перед трансляцией.

### Типы NAT

![image.png](image%20520.png)

1. Статический NAT
- Преобразует один частный IP-адрес в один общедоступный IP-адрес.
- Обычно используется в хостинге, но не является экономически эффективным для крупных организаций, поскольку для каждого устройства требуется общедоступный IP-адрес.
1. Динамический NAT
- Преобразует частные IP-адреса в общедоступные из предопределенного пула.
- Если пул исчерпан, дополнительные запросы удаляются.
- Подходит для сетей с ограниченным числом пользователей, но все еще является дорогостоящим решением.
1. Port Addres Translation (PAT)
- Также называется перегруженным NAT.
- Несколько частных IP-адресов используют один общий IP-адрес с уникальными номерами портов, отличающими трафик.
- Наиболее широко используется, поскольку он экономичен и поддерживает тысячи пользователей с помощью одного общедоступного IP-адреса.

### Prons of NAT

- Сохраняет адреса IPv4.
- Повышает безопасность, скрывая внутренние IP-адреса.
- Поддерживает использование несколькими устройствами одного общедоступного IP-адреса.
- Упрощает администрирование сети при объединении частных сетей.

### Cons of NAT

- Может увеличить нагрузку на маршрутизаторы.
- Могут возникнуть проблемы с приложениями, требующими сквозного подключения (например, VoIP, игры).
- Трудности с отслеживанием, поскольку несколько устройств используют один и тот же общедоступный IP-адрес.