# 5. Alemblic

Категория: Frameworks & Libraries
Статус: В процессе

Alemblic - инструмент для управления миграциями. 

### Что такое миграции

Есть приложение и вы создаете пару табличек, чтобы оно работало, ходило в них. Потом выкатываете новую версию, в которой что-то поменялось, — первая табличка поменялась, вторая нет, а третьей раньше не было, но она появилась.

![image.png](image%20398.png)

Потом появляется новая версия приложения, в которой какая-то табличка удаляется, с остальными ничего не происходит. Что это такое? Можно сказать, что это и есть состояние, которое можно описать миграцией. Когда мы переходим от одного состояния к другому, это upgrade, когда хотим вернуться назад — downgrade.

![image.png](image%20399.png)

![image.png](image%20400.png)

### Сравнение инструментов для миграций

![image.png](image%20401.png)

Рассмотрим Alemblic подробнее 

![image.png](image%20402.png)

Alemblic базируется на Sqlalchemy, немного рассмотрим ее:

![image.png](image%20403.png)

Из чего состоит SQLAlchemy?

![image.png](image%20404.png)

![image.png](image%20405.png)

MetaData — некий объект, контейнер, в который вы будете добавлять ваши таблицы, индексы и вообще все сущности, которые у вас есть. Это такой объект, который отражает, с одной стороны, то, как вы хотите видеть базу данных, исходя из вашего написанного кода. С другой стороны, MetaData может пойти в базу, получить snapshot того, что там реально есть, и сам построить эту объектную модель.

Также у объекта MetaData есть одна очень интересная особенность. Он позволяет вам задать шаблон наименования индексов и constraint’ов по умолчанию. Это очень важно, когда вы пишите миграции, потому что у каждой БД — будь то PostgreSQL, MySQL, MariaDB — есть какое-то свое видение того, как должны называться индексы.

![image.png](image%20406.png)

![image.png](image%20407.png)

![image.png](image%20408.png)

![image.png](image%20409.png)

![image.png](image%20410.png)

Структура Alemblic проекта 

![image.png](image%20411.png)

![image.png](image%20412.png)

![image.png](image%20413.png)

![image.png](image%20414.png)

[env.py](http://env.py/) — самый интересный файл в Alembic. Он контролирует ход выполнения команд и позволяет кастомизировать его под себя. Именно в этот файл вы подключаете ваш объект MetaData. Как я уже рассказывал, объект MetaData является реестром для всех сущностей вашей базы.

### Как сгенерировать миграции

![image.png](image%20415.png)

Вот как выглядит сгенерированная миграция

![image.png](image%20416.png)

![image.png](image%20417.png)

![image.png](image%20418.png)

### Тестирование миграций

![image.png](image%20419.png)

![image.png](image%20420.png)

![image.png](image%20421.png)

![image.png](image%20422.png)

Существует еще и stairway-тест, который получает список всех миграций и итерируется по ним. Для каждой из миграций он вызывает upgrade(), downgrade() и еще раз upgrade().

![image.png](image%20423.png)

Пример Stairway теста 

![image.png](image%20424.png)

Пример тестирования миграций с данными 

![image.png](image%20425.png)

### Использование enum

Допустим мы создали enum. Автоматически создали миграцию и она применилась.  

![image.png](image%20426.png)

Вроде бы все классно, но это не совсем так. Если мы сделаем downgrade, а потом попробуем вновь сделать upgrade, то выясниться, что в downgrade не удалился enum. Как исправить это - добавить строчку для удаления enum’a руками.

![image.png](image%20427.png)

Окей, но если нам нужно изменить сам enum, мы без проблем делаем это в коде, но автоматическая миграция просто проигнорирует изменения в enum’e и автоматическая миграция не сгенерируется.

Как вариант, использование чего-то в таком духе:

![image.png](image%20428.png)

Можно все это запихнуть и в отдельную функцию, но об этом стоит по-прежнему помнить и прописывать ручками. Решение использование библиотеки  [**alembic-postgresql-enum](https://github.com/RustyGuard/alembic-postgresql-enum).**

Использование

![image.png](image%20429.png)