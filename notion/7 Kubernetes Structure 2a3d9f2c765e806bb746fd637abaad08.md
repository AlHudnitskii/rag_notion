# 7. Kubernetes: Structure

Категория: Docker & Kubernetes
Статус: В процессе

Kubernetes — это портативная расширяемая платформа с открытым исходным кодом для управления контейнеризованными рабочими нагрузками и сервисами, которая облегчает как декларативную настройку, так и автоматизацию. Также его часто называют container orchestrator.
Основными функциями, которые предоставляет Kubernetes, являются:

- **Обнаружение служб и балансировка нагрузки.** Kubernetes может предоставлять доступ к контейнеру, используя DNS-имя или собственный IP-адрес. Если трафик на контейнер высок, Kubernetes может позволяет балансировать нагрузку и распределять сетевой трафик таким образом, чтобы развертывание было стабильным.
- **Система управления хранилищем.** Kubernetes позволяет автоматически подключать систему хранения данных по вашему выбору, например локальные хранилища, общедоступные облачные сервисы и многое другое.
- **Автоматическое развертывание и откат.** Вы можете описать желаемое состояние для ваших развернутых контейнеров с помощью Kubernetes, и оно может изменять фактическое состояние на желаемое с контролируемой скоростью. Например, вы можете автоматизировать Kubernetes для создания новых контейнеров для вашего развертывания, удаления существующих контейнеров и внедрения всех их функций.
ресурсы в новый контейнер.
- **Автоматическая упаковка в контейнер.** Вы предоставляете Kubernetes кластер узлов, который он может использовать для выполнения контейнеризованных задач. Вы сообщаете Kubernetes, сколько у вас процессора и оперативной памяти
потребности каждого контейнера. Kubernetes может размещать контейнеры на ваших узлах, чтобы наилучшим образом использовать ваши ресурсы.
- **Система самовосстановления.** Kubernetes перезапускает вышедшие из строя контейнеры, заменяет их, удаляет контейнеры, которые не отвечают на пользовательскую проверку работоспособности, и не сообщает о них клиентам до тех пор, пока они не будут готовы к обслуживанию.
- **Управление секретами и конфигурацией.** Kubernetes позволяет хранить конфиденциальную информацию, такую как пароли, токены OAuth и SSH-ключи, и управлять ею. Вы можете развертывать и обновлять секретные данные и конфигурацию приложения, не перестраивая образы контейнеров и не раскрывая секретные данные в конфигурации стека.
- **Пакетное выполнение.** В дополнение к сервисам Kubernetes может управлять вашими рабочими нагрузками в пакетном режиме и CI, заменяя при желании вышедшие из строя контейнеры.
- **Горизонтальное масштабирование.** Масштабируйте свое приложение вверх и вниз с помощью простой команды, пользовательского интерфейса или автоматически в зависимости от загрузки процессора.
- **IPv4/IPv6-распределение адресов.** IPv4 и IPv6 в двух стеках между модулями и службами
Разработано для обеспечения расширяемости, что позволяет добавлять функции в ваш кластер Kubernetes без изменения исходного кода.

### Архитектурные концепции, на которых строиться Kubernetes

Кластер Kubernetes состоит из уровня управления (control plane) и набора рабочих машин, называемых узлами (nodes), которые запускают контейнеризованные приложения. Каждому кластеру требуется как минимум один рабочий узел для запуска модулей.

[*Kubernetes-кластер](https://www.google.com/search?client=opera&q=Kubernetes-%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80&sourceid=opera&ie=UTF-8&oe=UTF-8&mstk=AUtExfDW62e5QAIxv8Je12db3Rj8dX5uQFS640MDXkipDrZBa_xB_fyqP1MCDoPoyt0cN65vkHo-fu4Ifl0SXh6LRSfLCF66_JPkLKE-N_pAZaYeUjibuuL4uekxLxkvIRezqhLnvUDpke9g6HX7n9-QVQNIbX9Af7QNsn4PiGhg6BmNq_0&csui=3&ved=2ahUKEwi84sejrr2RAxW3TFUIHUHdNfgQgK4QegQIARAB) (K8s) — это группа объединенных в сеть машин (узлов), которые вместе управляют запуском, масштабированием и работой ваших контейнеризированных приложений, автоматизируя их развертывание, управление и самовосстановление, превращая набор серверов в единую, отказоустойчивую систему.*

На рабочих узлах размещаются модули, которые являются компонентами рабочей нагрузки приложения. Уровень управления управляет рабочими узлами и модулями в кластере. В производственных средах уровень управления обычно работает на нескольких компьютерах, а в кластере обычно работает несколько узлов, что обеспечивает отказоустойчивость и высокую доступность.

![image.png](image%20464.png)

### Control plane components

Компоненты уровня управления принимают глобальные решения относительно кластера (например, планирование), а также обнаруживают события кластера и реагируют на них (например, запуск нового модуля, когда поле реплик развертывания не удовлетворено).

Компоненты Control plane могут быть запущены на любом компьютере в кластере. Однако для простоты сценарии установки обычно запускают все компоненты control plane на одном компьютере и не запускают пользовательские контейнеры на этом компьютере. 

- **kube-apiserver**

Сервер API является компонентом уровня управления Kubernetes, который предоставляет API Kubernetes. Сервер API - это интерфейс для платформы управления Kubernetes.

Основной реализацией API-сервера Kubernetes является kube-apiserver. kube-apiserver предназначен для горизонтального масштабирования, то есть он масштабируется за счет развертывания большего количества экземпляров. Вы можете запускать несколько экземпляров kube-apiserver и балансировать трафик между этими экземплярами.

- **etcd**

etcd — это распределенное, согласованное и отказоустойчивое хранилище данных типа «ключ-значение» (key-value store) с открытым исходным кодом, которое используется для хранения критически важной конфигурации, состояния и метаданных в распределенных системах, а главное — как основное хранилище всех данных кластера в Kubernetes.

- **kube-scheduler**

`kube-scheduler` — это **основной компонент плоскости управления Kubernetes, который отвечает за выбор оптимального рабочего узла (node) для запуска новых подов (pods), которые еще не назначены никакому узлу**. Он работает, анализируя требования пода, доступные ресурсы узлов и различные политики

- **kube-controller-manager**

`kube-controller-manager` – это основной демон в Kubernetes, который управляет контроллерами — компонентами, непрерывно отслеживающими состояние кластера и синхронизирующими текущее состояние с желаемым, описанным в конфигурациях (например, YAML-файлах), создавая, обновляя или удаляя объекты вроде подов и ReplicaSet. Он действует как мозг, поддерживающий стабильность кластера, реагируя на сбои узлов, обеспечивая нужное количество реплик подов и управляя доступом к API. 

Существует множество различных типов контроллеров. Вот некоторые из их примеров:

1. Node controller: отвечает за обнаружение и реагирование на сбои в работе узлов.
2. Job controller: отслеживает объекты заданий, представляющие разовые задачи, затем создает модули для выполнения этих задач до завершения.
3. Контроллер EndpointSlice: заполняет объекты EndpointSlice (чтобы обеспечить связь между службами и модулями).
4. ServiceAccount controller: Создайте учетные записи служб по умолчанию для новых пространств имен.
- **cloud-controller-manager**

Cloud Controller Manager (CCM) — это ключевой компонент Kubernetes, который обеспечивает глубокую интеграцию кластера с API облачного провайдера (AWS, Azure, GCP, OpenStack и т. д.), позволяя управлять облачными ресурсами (балансировщики нагрузки, диски, сети) прямо из Kubernetes, делая кластер «облачно-aware». 

Следующие контроллеры могут зависеть от облачного провайдера:

1. Node controller: Для проверки облачного провайдера, чтобы определить, был ли удален узел в облаке после того, как он перестал отвечать на запросы
2. Route controller: Для настройки маршрутов в базовой облачной инфраструктуре
3. Service controller: Для создания, обновления и удаления балансировщиков нагрузки облачного провайдера

### Node Components

Компоненты узла запускаются на каждом узле, поддерживая работу модулей и обеспечивая среду выполнения Kubernetes.

- **kubelet**

Агент, который запускается на каждом узле в кластере. Он обеспечивает работу контейнеров в модуле.
Kubelet — это основной агент Kubernetes, работающий на каждом рабочем узле ([Node](https://www.google.com/search?q=Node&client=opera&sca_esv=be6047ef5dda0c71&sxsrf=AE3TifPsW6sfKQh0DykWa8S0vJKvqIaNAA%3A1765726012853&ei=PNc-aaPrM8GZ1fIPpYLU-QY&ved=2ahUKEwjZxLLDtL2RAxXZMBAIHcxVDQ0QgK4QegQIARAC&uact=5&oq=kubelet+%D1%87%D1%82%D0%BE+%D1%8D%D1%82%D0%BE+%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%3F&gs_lp=Egxnd3Mtd2l6LXNlcnAiIWt1YmVsZXQg0YfRgtC-INGN0YLQviDRgtCw0LrQvtC1PzIIEAAYgAQYogQyCBAAGKIEGIkFMgUQABjvBUjHDVAAWIIHcAB4AZABAJgBdKABwgGqAQMxLjG4AQPIAQD4AQL4AQGYAgKgAskBmAMAkgcDMS4xoAeSBbIHAzEuMbgHyQHCBwMwLjLIBwSACAA&sclient=gws-wiz-serp&mstk=AUtExfCWelwS107nWE1hWJ3QAJyjNNeGyjDZiWFGaLBrqxiPozPcqovNSmuEvB4TAQAeeZp1i58h-oRqwD81iydM7rFASmOjUjXiJQI0-mSWqa3wFMlBiHDKZQnGNMMOxa4RfL0Die_Q1DG2n0t3b2I3DGmjORY8_DsQ47vNYcsstKSOINc&csui=3)) кластера, который отвечает за запуск и управление контейнерами в подах ([Pods](https://www.google.com/search?q=Pods&client=opera&sca_esv=be6047ef5dda0c71&sxsrf=AE3TifPsW6sfKQh0DykWa8S0vJKvqIaNAA%3A1765726012853&ei=PNc-aaPrM8GZ1fIPpYLU-QY&ved=2ahUKEwjZxLLDtL2RAxXZMBAIHcxVDQ0QgK4QegQIARAD&uact=5&oq=kubelet+%D1%87%D1%82%D0%BE+%D1%8D%D1%82%D0%BE+%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%3F&gs_lp=Egxnd3Mtd2l6LXNlcnAiIWt1YmVsZXQg0YfRgtC-INGN0YLQviDRgtCw0LrQvtC1PzIIEAAYgAQYogQyCBAAGKIEGIkFMgUQABjvBUjHDVAAWIIHcAB4AZABAJgBdKABwgGqAQMxLjG4AQPIAQD4AQL4AQGYAgKgAskBmAMAkgcDMS4xoAeSBbIHAzEuMbgHyQHCBwMwLjLIBwSACAA&sclient=gws-wiz-serp&mstk=AUtExfCWelwS107nWE1hWJ3QAJyjNNeGyjDZiWFGaLBrqxiPozPcqovNSmuEvB4TAQAeeZp1i58h-oRqwD81iydM7rFASmOjUjXiJQI0-mSWqa3wFMlBiHDKZQnGNMMOxa4RfL0Die_Q1DG2n0t3b2I3DGmjORY8_DsQ47vNYcsstKSOINc&csui=3)), обеспечивая их соответствие спецификациям, описанным в PodSpec, и взаимодействие с API-сервером для поддержания состояния всего кластера, управляя жизненным циклом контейнеров и мониторя ресурсы узла.  Kubelet не управляет контейнерами, которые не были созданы Kubernetes.

- **kube-proxy (необязательно)**

`kube-proxy` — это сетевой прокси-сервис Kubernetes, работающий на каждом узле кластера и отвечающий за маршрутизацию и распределение сетевого трафика к подам, реализуя концепцию [Kubernetes Service](https://www.google.com/url?sa=i&source=web&rct=j&url=https://kubernetes.io/ru/docs/concepts/overview/components/&ved=2ahUKEwic8tfetL2RAxWZIBAIHYHdO4wQy_kOegQIARAB&opi=89978449&cd&psig=AOvVaw2RyoMASZtE5gTnoP6hfcc0&ust=1765813152209000) (сервиса).

kube-proxy использует уровень фильтрации пакетов операционной системы, если таковой имеется и доступен. В противном случае kube-proxy сам перенаправляет трафик.

- **Container runtime**

Фундаментальный компонент, который позволяет Kubernetes эффективно запускать контейнеры. Он отвечает за управление выполнением и жизненным циклом контейнеров в среде Kubernetes.

Kubernetes поддерживает контейнерные среды выполнения, такие как containerd, CRI-O и любые другие реализации Kubernetes CRI (Container Runtime Interface).

### **Nodes**

В Kubernetes [**узел (Node)**](https://www.google.com/search?q=%D1%83%D0%B7%D0%B5%D0%BB+%28Node%29&client=opera&sca_esv=be6047ef5dda0c71&sxsrf=AE3TifMrpud3Dg5ZFBJrDHy4HrdMqrfrRg%3A1765726980941&ei=BNs-af2WOZyvwPAP96OOgQI&ved=2ahUKEwi5h6DNtb2RAxXFCRAIHTGsK-YQgK4QegQIARAB&uact=5&oq=node+%D0%B2+kubernetes+%D1%87%D1%82%D0%BE+%D1%8D%D1%82%D0%BE+%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%3F&gs_lp=Egxnd3Mtd2l6LXNlcnAiLG5vZGUg0LIga3ViZXJuZXRlcyDRh9GC0L4g0Y3RgtC-INGC0LDQutC-0LU_MgQQABhHMgQQABhHMgQQABhHMgQQABhHMgQQABhHMgQQABhHMgQQABhHMgQQABhHSMsGUPECWPECcAF4ApABAJgBAKABAKoBALgBA8gBAPgBAZgCAqACCMICChAAGLADGNYEGEeYAwDiAwUSATEgQIgGAZAGCJIHATKgBwCyBwC4BwDCBwUwLjEuMcgHBYAIAA&sclient=gws-wiz-serp&mstk=AUtExfD2GNWILfWB6z95tNFH22CzGQGoia3RXs8rkZyCKzBbdngF-jWtaK8piQmUigxh6vtddwFeo_ofBT3OAMiZHApvlvu8sfJtwN5DK2ol-TM92SvH3Uq1QqIYqQGWqvX6JwhSI6GWgstk_nRlrWoTNBGRTh4THDzELNIJ9hYM1iMc3RoGmD-mPnhsuEJDVqifZh8CJEZZuWmLd35QuOSEKp326AkusCQlMAvnmZ8r3lDyrGIvohObLNrTcbPJ9juNWhjF3o7ftUGQqmj3IDzsQ5kWgaxl1hVzfen0jYYeda6MZg&csui=3) — это рабочая машина (физическая или виртуальная), являющаяся строительным блоком кластера, где запускаются и работают ваши приложения в виде контейнеров, упакованных в поды, под управлением Control Plane (управляющего слоя). Каждый узел предоставляет вычислительные ресурсы (CPU, память) и содержит компоненты для взаимодействия с Control Plane и запуска контейнеров, такие как Kubelet, среду выполнения контейнеров (например, Docker) и Kube-proxy. 

Существует 2 типа узлов:

1. Узел controller plane, который регистрируется по умолчанию
2. Рабочий узел, который можно создать руками

![image.png](image%20465.png)

Когда флаг kubelet --register-node имеет значение true (по умолчанию), kubelet попытается зарегистрироваться на сервере API. Это предпочтительный шаблон, используемый большинством дистрибутивов.

Для самостоятельной регистрации kubelet запускается со следующими параметрами:

- -kubeconfig - Путь к учетным данным для аутентификации на сервере API.
- -cloud-provider - Как связаться с поставщиком облачных услуг, чтобы прочитать метаданные о нем.
- -register-node - Автоматическая регистрация на сервере API.
- -зарегистрировать с помощью taints - Зарегистрировать узел с заданным списком taints (через запятую <ключ>=<значение>:<эффект>).

### Pods

В Kubernetes Под (Pod) — это минимальная и атомарная единица развертывания, представляющая собой логическую группу из одного или нескольких тесно связанных контейнеров (например, Docker) и общих ресурсов для них, таких как хранилище и сеть, выполняющихся на одном узле (виртуальной или физической машине) кластера. 

По сути, Под — это "логический хост" для ваших приложений, обеспечивающий им общее окружение и возможность взаимодействия.

Ключевые характеристики Пода:

- Группа контейнеров: Может содержать один контейнер или несколько, которые работают вместе и делят ресурсы.
- Общие ресурсы: Контейнеры в одном Поде разделяют сетевое пространство (IP-адрес, порты) и могут использовать общие тома (volumes) для хранения данных.
- Единство размещения: Все контейнеры Пода всегда запускаются на одном и том же узле кластера.
- Эфемерность: Поды, как правило, создаются и уничтожаются автоматически контроллерами (например, Deployment), а не вручную, являясь временными "строительными блоками".
- Абстракция: Представляют собой уровень приложения, а не инфраструктуры (узлы — это инфраструктура).

Зачем он нужен? - Поды решают проблемы масштабирования и управления контейнерами, позволяя Kubernetes:

- Группировать тесно связанные сервисы (например, основное приложение и его sidecar-контейнер для логирования).
- Обеспечивать изоляцию и совместно использовать ресурсы между этими группами.
- Управлять жизненным циклом контейнеров как единым целым.

Способы создать Pod

![image.png](image%20466.png)

### **Sets**

ReplicaSet, Deployment, StatefulSet, DaemonSet — это контроллеры в Kubernetes, которые управляют жизненным циклом подов (контейнеров) и обеспечивают их доступность, но для разных сценариев: 

- Deployment — для stateless-приложений (веб-серверы, балансировщики);
- StatefulSet — для stateful-приложений (базы данных);
- DaemonSet — для служб, работающих на каждом узле (логирование, мониторинг);
- ReplicaSet — базовый уровень, обеспечивающий нужное количество реплик, управляемый Deployment'ами.

### Deployments