# 12. Functions & Procedures

Категория: SQL Databases
Статус: Готово

## Общая информация

В SQL помимо обычных запросов существуют более мощные инструменты - процедуры и функции. Эти объекты позволяют создавать готовые блоки кода, которые можно многократно использовать.  

Основные различия между процедурами и функциями

![image.png](image%20494.png)

![image.png](image%20495.png)

Простое правило выбора 

- Нужно получить одно значение для использования в запросе? → Функция
- Нужно выполнить набор действий или изменить данные? → Процедура

## Хранимые функции в SQL

**Хранимая функция** — это именованный блок SQL-кода, который принимает параметры, выполняет вычисления и всегда возвращает одно значение определённого типа.

Функции всегда выполняются как часть транзакции.

![image.png](image%20496.png)

### Общая структура хранимой функции

![image.png](image%20497.png)

Пример - функция для определения совершеннолетия человека

![image.png](image%20498.png)

Хранимые функции могут выполнять запросы к БД

![image.png](image%20499.png)

Здесь внутри функции мы используем DECLARE для объявления переменной v_product_name типа VARCHAR(50). 

**Важно для PostgreSQL:** Все переменные должны быть объявлены в блоке DECLARE до начала тела функции (до BEGIN). Объявлять переменные внутри тела функции нельзя.

Для просмотра всех функций можно воспользоваться `information_schema.routines` .

![image.png](image%20500.png)

Для удаления функции

![image.png](image%20501.png)

### Особенности

1. На аргументы SQL-функции можно ссылаться в теле функции, используя имена или номера:

![image.png](image%20502.png)

## Хранимые процедуры

Хранимые процедуры — это программные блоки, которые выполняют определённую последовательность действий в базе данных.

В отличие от функций, процедуры могут изменять данные, выполнять сложную бизнес-логику, но не могут возвращать значения. Могут внутри себя управлять транзакциями (BEGIN, COMMIT, ROLLBACK) внутри тела процедуры.

### **Общая структура хранимой процедуры**

![image.png](image%20503.png)

Пример простой процедуры

![image.png](image%20504.png)

Для просмотра хранимых процедур

![image.png](image%20505.png)

Удаление процедуры

![image.png](image%20506.png)

### Особенности

1. Использование выходных параметров в процедурах 

Выходные параметры должны быть включены в список аргументов команды `CALL`

![image.png](image%20507.png)

Чтобы вызвать эту процедуру, необходимо указать аргумент, соответствующий параметру `OUT`. Обычно используется `NULL`:

![image.png](image%20508.png)

1. Параметры
- **IN** (по умолчанию) — входной параметр
- **OUT** — выходной параметр
- **INOUT** — входной и выходной одновременно

![image.png](image%20509.png)

![image.png](image%20510.png)