# 3. CAP & PACELC

Категория: NoSQL & General theory
Статус: Готово

### CAP

Эта теорема была представлена в 2000 году Эриком Брюером. 

В CAP говорится, что в распределенной системе возможно выбрать только 2 из 3-х свойств:

- C (consistency) — согласованность. Каждое чтение даст вам самую последнюю запись.
- A (availability) — доступность. Каждый узел (не упавший) всегда успешно выполняет запросы (на чтение и запись).
- P (partition tolerance) — устойчивость к распределению. Даже если между узлами нет связи, они продолжают работать независимо друг от друга.

![image.png](image%20629.png)

1. Следующие пункты относятся к абстрактной распределенной БД Postgresql.
- Репликация Master-Slave — одно из распространенных решений
- Синхронизация с Master в асинхронном / синхронном режиме
- Система транзакций использует двухфазный коммит для обеспечения consistency
- Если возникает partition, вы не можете взаимодейстовать с системой (в основном случае)

Таким образом, система не может продолжать работу в случае partition, но обеспечивает strong consistency и availability. Это система CA!

1. Следующие пункты относятся к абстрактной распределенной БД MongoDB.
- MongoDB обеспечивает strong consistency, потому что это система с одним Master узлом, и все записи идут по умолчанию в него.
- Автоматическая смена мастера, в случае отделения его от остальных узлов.
- В случае разделения сети, система прекратит принимать записи до тех пор, пока не убедится, что может безопасно завершить их.

Таким образом, система может продолжать работу в случае разделения сети, но теряется CAP-availability всех узлов. Это CP система!

### Проблемы CAP теоремы:

- Далёкие от реального мира определения
- В рамках разработки, выбор в основном лежит между CP и AP
- Множество систем — просто P
- Чистые AP и CP системы могут быть не тем, что ожидаешь

## PACELC

![image.png](image%20630.png)

[https://habr.com/ru/companies/gaz-is/articles/551986/](https://habr.com/ru/companies/gaz-is/articles/551986/)

В данной теореме мы видим не просто треугольник СAP, а условное дерево, которое можно представить в виде if (P, then A or C, else L or C), где есть уже знакомые нам (P)artitioning, (A)valability, (С)onsistency, а также новое понятие (L)atency – общее время задержки от момента выполнения действия пользователем до момента предоставления ему результата.

Простыми словами, при условии наличия сетевого разделения (P)artitioning система может выбрать одно из двух: доступность (A)vailability или консистентность (С)onsistensy, иначе (E)lse, если сетевого разделения нет, система может выбрать одно из двух: время задержки (L)atency или консистентность (С)onsistensy.

Так как грани теоремы PACELC стали более детально описывать системы, то назначения систем, использующих разные комбинации граней, могут быть не до конца понятны. Рассмотрим их более детально.

### PA/EL

Внутренние бизнес-процессы больших компаний, в частности internet-based, зачастую ставят два условия для решений, предназначенных для хранения и обработки данных: высокая доступность (A) при разделении (P) системы иначе (E) высокая скорость ответа (L).

Пример БД, которая изначально построена максимально приближено к этой конфигурации- Cassandra – база данных для работы с системой сообщений от компании Facebook, в дальнейшем переданная Apache Foundation.

### **PC/EC**

Как мы видим по названию, системы, которые стараются максимально приблизиться к парадигме ACID с большой долей вероятности будут жертвовать доступностью (A) в угоду консистентности (С), используя огораживание (fencing) при разделении (P) в распределённых системах. В неразделённых (E)lse системах «под нож» пойдёт скорость (L)atency, так как консистентность – это один из столпов ACID.

VoltDB/H-Store – ACID-совместимые БД, разработаны группой ученых. К созданию причастен и сам автор PACELS теории, профессор Дэниель Абади.

Megastore – проект от компании Google, для закрытия определённых ACID-потребностей в собственных облачных хранилищах.

### **PC/EL**

Данная архитектура при разделении стремится оставаться консистентной, а в случае без сетевых разделений, фокусируется на скорости ответа, отводя консистентность на второй план. Классическим, но не идеальным примером данной архитектуры стала [PNUTS](https://sites.cs.ucsb.edu/~agrawal/fall2009/PNUTS.pdf) – база данных, разработанная компанией Yahoo!, которая в распределённых средах обеспечивает [«Timeline (С)onsistency»](https://blog.yugabyte.com/a-for-apple-b-for-ball-c-for-cap-theorem/) на всех репликах.

### **PA/EC**

При наличии сетевого разделения системы ставка делается на доступность, а при отсутствии распределения – на консистентность. С[о слов самого автора теории PACELS – In Memory Data Grid](https://dzone.com/articles/hazelcast-and-the-mythical-paec-system), решения в определённых конфигурациях имеют характеристики PA/EC. В частности, решение [Hazelcast](https://jepsen.io/analyses/hazelcast-3-8-3) может быть сконфигурировано с использованием специальной настройки гибридной синхронности. В случае разделения – (P)artitioning, сконфигурированная таким образом система не даст консистентности, но предоставит (A)valability, а в (E)lse и строгую (С)onsistency.