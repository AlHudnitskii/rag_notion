# 6. Mock & Fixtures

Категория: Testing
Статус: В процессе

**Mock (заглушка, имитация)** — это объект-подделка, который имитирует поведение реального объекта, но не выполняет его настоящую логику.

**Зачем нужны моки? Фундаментальные причины:**

1. **Изоляция unit-тестов**
    - Unit-тест должен тестировать ТОЛЬКО одну единицу кода (функцию, метод, класс)
    - Все зависимости должны быть изолированы
    - Если тест падает, мы точно знаем ГДЕ проблема
2. **Независимость от внешних систем**
    - Базы данных могут быть недоступны
    - Внешние API могут быть платными или иметь rate limits
    - Файловая система может быть read-only
    - Сетевые запросы могут быть медленными
3. **Скорость выполнения**
    - Реальный HTTP-запрос: 100-500ms
    - Mock HTTP-запроса: < 1ms
    - Тысячи тестов должны выполняться за секунды
4. **Детерминированность**
    - Реальные системы дают разные результаты (time.now(), random())
    - Моки возвращают предсказуемые данные
    - Тесты должны быть воспроизводимыми
5. **Тестирование граничных случаев**
    - Как протестировать ошибку сети? Выдернуть кабель?
    - Как протестировать падение БД? Уронить сервер?
    - Моки позволяют симулировать любые сценарии

**Когда использовать моки:**

- ✅ Внешние API и сетевые запросы
- ✅ База данных (для unit-тестов)
- ✅ Файловая система
- ✅ Время (datetime.now(), time.sleep())
- ✅ Случайные числа (random)
- ✅ Email-сервисы, SMS-шлюзы
- ✅ Внешние зависимости (Celery, Redis, RabbitMQ)

**Когда НЕ использовать моки:**

- ❌ Простые вычислительные функции
- ❌ Data classes / модели
- ❌ Integration тесты (там нужны реальные компоненты)
- ❌ Чрезмерное мокирование (если мокируете всё — тестируете ничто)

### unittest.mock

![image.png](image%20313.png)

![image.png](image%20314.png)

**Fixture (оснастка, приспособление)** — это переиспользуемый код для подготовки тестового окружения.

**Зачем нужны фикстуры? Фундаментальные причины:**

1. **DRY (Don't Repeat Yourself)**
    - Избавление от дублирования кода подготовки
    - Единое место для изменений
2. **Композиция**
    - Фикстуры могут использовать другие фикстуры
    - Построение сложных зависимостей
3. **Управление ресурсами**
    - Setup (подготовка)
    - Teardown (очистка)
    - Гарантия освобождения ресурсов
4. **Dependency Injection**
    - pytest автоматически внедряет зависимости
    - Явное указание зависимостей через параметры

### **Setup и Teardown с yield**

![image.png](image%20315.png)

![image.png](image%20316.png)

![image.png](image%20317.png)

**Фикстуры — для подготовки данных и ресурсов:**

- Создание тестовых объектов
- Настройка БД
- Подготовка файлов
- Создание тестовых пользователей

**Моки — для изоляции зависимостей:**

- Подмена внешних API
- Симуляция ошибок
- Проверка взаимодействий
- Ускорение тестов

![image.png](image%20318.png)

### Best Practices

1. Принцип минимального мокирования
2. Явные зависимости через параметры
3. **Тестируйте поведение, а не реализацию**
4. Один тест — одна концепция