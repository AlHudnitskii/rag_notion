# 15. Window functions

Категория: SQL Databases
Статус: Готово

Оконные функции - мощный инструмент SQL, позволяющий проводить сложные вычисления по группам строк, которые связаны с текущей строкой. 

Когда применяются оконные функции, запрос сегментируется на группы строк (или «окна»), и для каждого такого сегмента подсчитываются индивидуальные агрегатные значения.

Это окно, которое подаётся в оконную функцию, может быть:

- всей таблицей
- отдельными партициями таблицы, то есть группой строк на основе одного или нескольких полей
- или даже конкретным диапазоном строк в пределах таблицы или партиции. Например, мы можем определить окно, которое будет передаваться в оконную функцию, как предыдущая + текущая строка таблицы. И тогда для каждой строки значение агрегатной функции будет подсчитываться по-своему, так как данные, которые поступают в функцию будут динамически меняться от строке к строке. Окно будет как бы «скользить» по таблице.

### Синтаксис оконной функции

![image.png](image%20607.png)

Далее внутри OVER следуют 3 необязательных параметра, с помощью которых можно гибко настраивать окно:

- с помощью PARTITION BY <столбцы_для_разделения> выборка делится на непересекающиеся подмножества, где каждое подмножество содержит строки с одинаковыми значениями в одном или нескольких столбцах, образуются партиции.
- с помощью ORDER BY <столбцы_для_сортировки> устанавливается порядок строк внутри окна, особо важную роль играет в оконных функциях ранжирования.
- с помощью ROWS|RANGE <определение_диапазона_строк> формируются диапазоны строк. С помощью этого параметра можно указать сколько строк брать до и после текущей в окно.

### Партиции в оконных функциях

Партиции — подмножества строк, выделенные для оконной функции на основе одного или нескольких столбцов в таблице.

Они служат для сегментации данных, позволяя выполнить более детальный анализ и расчёты вроде агрегации или ранжирования внутри каждой такой группы.

Пример выделения партиции (их можно задавать и по нескольким колонкам):

![image.png](image%20608.png)

### Сортировка внутри окна

Сортировка в оконных функциях SQL — ключ к расширенному анализу данных. Она позволяет упорядочивать данные внутри определённой группы или окна, обеспечивая более точные и нацеленные агрегатные вычисления. Это особенно полезно при работе с временными рядами, где важен порядок событий, или при ранжировании данных внутри групп.

![image.png](image%20609.png)

1. Данные в рамках партиции стали отсортированы по дате начала бронирования
2. Изменился способ подсчёта общей суммы затраченных средств: теперь сумма в рамках партиции накапливается, а не выводится как финальная

### Рамки в оконных функциях

Окно VS Партиция

- Партиция (PARTITION BY). Это деление всего набора результатов на непересекающиеся подмножества, где каждое подмножество содержит строки с одинаковыми значениями в одном или нескольких столбцах. Оконные функции применяются отдельно к каждой партиции, как если бы каждая из них была отдельным набором данных.
- Окно. Определяет, какие конкретные строки в каждой партиции будут использоваться для вычисления оконной функции для каждой строки. Окно может изменяться от строки к строке.

### Определение границ окон

Используя синтаксис ROWS или RANGE мы можем определить какое именно окно с данными будет передаваться в оконную функцию для вычисления значения для текущей строки.

Синтаксис определения границ окна выглядит как указание диапазона относительно текущей строки.

![image.png](image%20610.png)

### Rows VS Range

ROWS:

- Основан на физических строках:
    
    При использовании ROWS, определение окна основывается на физическом положении строк относительно текущей строки. Например, 1 PRECEDING означает одну строку до текущей.
    
- Точная граница:
    
    Определение окна с помощью ROWS чётко ограничивает количество строк, которые включаются в окно, делая его предсказуемым и конкретным.
    

RANGE:

- Основан на значениях:
    
    RANGE, в отличие от ROWS, определяет границы окна на основе значений столбцов, упорядоченных в соответствии с ORDER BY в оконной функции.
    
- Динамичность границ:
    
    Границы, определённые с помощью RANGE, могут варьироваться в зависимости от данных, что делает окно гибким, но потенциально менее предсказуемым.
    

### Оконные функции

![image.png](image%20611.png)

![image.png](image%20612.png)

![image.png](image%20613.png)

ROW_NUMBER - номер строки внутри запроса

RANK - Ранг каждой строки. Обнуляется при переходе на новую партицию

DENSE_RANK - Тоже самое, что и RANK, но счетчик не увеличивается, если значения строк одинаковы. 

![image.png](image%20614.png)

LAG - Обращается к данным из предыдущих, можно указать число строк для смещения.

LEAD - Обращается к данным из следующих строк, также можно указать число строк для смещения.

FIRST_VALUE - возвращает первое значение в окне. В качестве аргумента принимает столбец, значение которого необходимо вернуть.

LAST_VALUE - возвращает последнее значение в окне. В качестве аргумента принимает столбец, значение которого необходимо вернуть.